--find the percentage of orders delivered in the preffered time for the first time orders of all customers

WITH first_order AS(
SELECT *, RANK() OVER (partition by customer_id order by order_date) AS rank
FROM Delivery)

SELECT  ROUND(SUM(case when order_date = customer_pref_delivery_date then 100.00 else 0.00 end)/COUNT(order_date),2) AS immediate_percentage
FROM first_order
WHERE rank = 1


--find the biggest number that appeared once

WITH single_num AS 
(SELECT num
FROM MyNumbers 
GROUP BY num
HAVING COUNT(num)=1)

SELECT MAX(num) as num
FROM single_num

--find info for the first year of every product sold
--version 1 with rank
with ranked_sales as(
select product_id, year as first_year, quantity, price, rank() over (partition by product_id order by year) as rnk
from Sales
)

select product_id, first_year, quantity, price
from ranked_sales
where rnk=1

--version2 with join
with first_year_sale as (
  select product_id, min(year) as year
  from Sales
  group by product_id
)

select s.product_id, s.year as first_year, quantity, price
from Sales s right join first_year_sale f on s.product_id = f.product_id and s.year = f.year 



